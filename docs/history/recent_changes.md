## 2025년 7월 27일 일요일

### `dungeon_map.py` 수정
- **`move_player` 함수 로직 개선**: 플레이어 이동 로직을 수정하여 맵 경계, 몬스터, 이동 가능 타일(벽 등) 순서로 충돌을 명확하게 확인하도록 변경했습니다. 이를 통해 벽에 막혔을 때의 비정상적인 대각선 이동, 몬스터와 충돌 시 전투가 시작되지 않는 문제, 벽을 통과하는 버그를 수정했습니다.
- **`can_move` 함수 삭제**: 새로운 `move_player` 함수 내에서 타일 이동 가능성 검사가 직접 처리되므로, 더 이상 필요 없어진 `can_move` 함수를 삭제하여 코드를 정리했습니다.
- **`get_tile_for_display` 함수 로직 변경**: 
    - 기존에 순수 문자만 반환하던 방식에서, ANSI 이스케이프 코드를 포함하여 색상까지 적용된 완전한 문자열을 반환하도록 수정했습니다. 이로써 맵 타일 표시에 대한 책임이 `dungeon_map.py`로 중앙화되었습니다.
    - 몬스터가 죽었을 때(`monster.dead == True`), 해당 위치에 붉은색 시체 기호(`†`)를 표시하도록 로직을 추가했습니다.
    - 플레이어가 사망했을 때, 해당 위치에 흰색 무덤(`묘`)이 표시되도록 로직을 추가했습니다.
    - 안개가 꺼져 있을 때(`fog_enabled == False`)는 `visited` 여부와 상관없이 모든 타일을 그리도록 수정하여, 안개 토글 기능이 올바르게 작동하도록 변경했습니다.
- **`__init__` 수정**: `player_tombstone` 속성을 추가하여 플레이어의 무덤 위치를 저장할 수 있도록 했습니다.
- **`toggle_fog` 함수 로직 수정**: 안개를 다시 켤 때 `visited` 세트를 초기화하던 로직을 제거하여, 이전에 탐험했던 영역이 그대로 유지되도록 수정했습니다. 이제 안개 토글은 단순히 렌더링 여부를 결정하는 플래그 역할만 합니다.

### `ui.py` 수정
- **`draw_game_screen`의 맵 렌더링 로직 수정**:
    - **맵 밀림 현상 해결**: 맵을 그릴 때 문자의 '개수'가 아닌 실제 '너비'(`wcswidth` 기준)를 계산하여 한 줄을 채우도록 로직을 근본적으로 수정했습니다. 이로써 한글처럼 너비가 2인 문자가 포함된 줄이 다른 줄보다 길어져 맵이 밀리고 깨져 보이던 심각한 렌더링 버그를 해결했습니다.
    - **로직 단순화**: `dungeon_map.get_tile_for_display`가 색상까지 포함된 문자열을 반환하게 됨에 따라, `ui.py` 내에서 자체적으로 타일 종류를 판단하고 색상을 입히던 중복 로직을 제거했습니다.
- **`NameError` 수정**: `draw_game_screen` 함수 내에서 `map_x`, `map_y` 변수가 누락되어 발생하던 오류를 수정했습니다.

### `game.py` 수정
- **플레이어 사망 처리 로직 개선**: 플레이어가 사망하면, 게임오버 메시지를 표시하고 `dungeon_map`에 무덤 위치를 기록한 후, 무덤이 포함된 마지막 맵을 다시 그려주도록 수정했습니다. 또한, 사용자가 마지막 화면을 확인하고 아무 키나 누를 때까지 대기하도록 하여 게임오버 경험을 개선했습니다.
- **몬스터 AI 이동 로직 개선**:
    - 몬스터의 추격 및 도망 로직을 대폭 수정하여, 대각선 이동 시 벽의 모서리를 통과하던 치명적인 버그(corner-cutting)를 해결했습니다.
    - 이제 몬스터는 대각선 경로가 막혀있지 않을 때만 대각선으로 이동하며, 경로가 막혔을 경우 수평 또는 수직으로 차선책을 시도하는 더 지능적인 움직임을 보여줍니다.
- **Fog of War 토글 버그 수정**: Fog of War 토글 액션 처리 후 `continue` 문을 추가하여, 게임 루프가 즉시 다음 반복으로 넘어가도록 수정했습니다. 이를 통해 플레이어가 출입구나 계단 위에서 안개를 토글할 때, 의도치 않게 레벨 이동이 발동되어 맵이 재생성되던 심각한 버그를 해결했습니다.

## 2025년 7월 30일 수요일

### 렌더링 시스템 리팩터링 및 안정화
- **`dungeon/ui.py` 전체 리팩터링**:
    - **렌더링 방식 재설계**: 수차례에 걸쳐 발생했던 렌더링 오류(화면 깨짐, 밀림, 성능 저하)를 해결하기 위해 UI 렌더링 시스템을 전면 재설계했습니다.
    - **직접 그리기 방식 채택**: 복잡한 더블 버퍼링 로직을 제거하고, 안정성이 높은 **직접 그리기(direct drawing)** 방식으로 전환했습니다.
    - **넓은 문자 처리 문제 해결**: `wcswidth`를 사용하여 한글, 특수문자 등 넓은 문자의 시각적 너비를 정확히 계산하고, 이에 맞춰 한 줄을 구성하도록 `_draw_map_and_entities` 함수를 수정했습니다. 이로써 몬스터나 시체 기호('†')가 포함된 줄에서 맵이 밀리던 고질적인 버그를 최종적으로 해결했습니다.
    - **성능 최적화**: 한 글자씩 화면에 출력하던 비효율적인 방식 대신, 한 줄(line) 단위로 완성된 문자열을 만들어 `sys.stdout.write` 호출 횟수를 최소화함으로써 렌더링 성능을 확보했습니다.
- **`dungeon_map.py` 수정**:
    - 안개(Fog of War) 처리 로직을 `ui.py`로 이전하여, `get_tile_for_display` 함수가 타일 자체의 모양만 반환하도록 역할을 명확히 했습니다.
- **기타 버그 수정**:
    - 리팩터링 과정에서 발생했던 `AttributeError`, `TypeError`, 순환 참조, 문법 오류 등 다양한 부수적 버그들을 모두 수정했습니다.

### `fix(render)`: 맵 표시 문자 고정 너비로 통일
- **넓은 문자(Wide Character) 문제 해결**: 렌더링 오류의 근본 원인이었던 넓은 문자(Nerd Font 아이콘 '👻', 시체 기호 '†') 사용을 중단했습니다.
- **고정 너비 문자로 교체**:
    - **몬스터**: `monster_data.txt`의 몬스터 심볼을 각 영문 이름의 첫 글자(g, o, s)로 변경했습니다.
    - **시체**: `dungeon_map.py`에서 시체 기호를 '%'로 변경했습니다.
- **렌더링 로직 단순화**: 모든 표시 문자의 너비가 1로 통일됨에 따라, `ui.py`의 `_draw_map_and_entities` 함수에서 복잡한 너비 계산 로직을 제거하고, 맵 타일 개수에 맞춰 문자를 그리는 단순하고 명확한 방식으로 최종 수정했습니다. 이를 통해 렌더링 안정성과 성능을 확보했습니다.
- **관련 모듈 수정**: `data_manager.py`, `monster.py` 등 몬스터 심볼 변경에 영향을 받는 모든 파일을 업데이트했습니다.

## 2025년 7월 31일 목요일

### 렌더링 시스템 근본 수정 및 안정화
- **문제 식별**: 플레이어의 비정상적인 이동, 잘못된 충돌 감지 등 모든 문제의 근본 원인이 **맵 렌더링 밀림 현상**임을 최종적으로 확인했습니다. 이는 너비가 다른 문자(한글, 특수문자, ASCII)가 혼용되어 발생했습니다.
- **`dungeon_map.py` 수정**:
    - **타일 문자 ASCII로 통일**: 맵을 구성하는 모든 타일 정의(벽, 바닥, 플레이어, 시작/끝, 아이템 등)를 너비가 2인 한글/특수문자에서 너비가 1인 ASCII 문자로 전면 교체했습니다. (예: `웃` -> `@`, `문` -> `>`, `　` -> ` `)
    - **특수 기호 변경**: 플레이어 무덤(`묘` -> `T`), 몬스터 시체(`X` -> `%`) 등 모든 표시 문자를 고정 너비 문자로 변경했습니다.
- **`player.py` 수정**:
    - **플레이어 문자 변경**: `dungeon_map.py`의 변경에 맞춰 플레이어의 기본 표시 문자(`char`)를 `'웃'`에서 `'@'`로 수정하여 일관성을 확보했습니다.
- **`ui.py` 수정**:
    - **렌더링 로직 대폭 단순화**: `_draw_map_and_entities` 함수에서 `wcswidth`를 사용한 복잡한 너비 계산 및 패딩 로직을 완전히 제거했습니다.
    - **안정성 확보**: 모든 문자의 너비가 1로 통일되었으므로, 이제 단순히 맵 뷰포트의 크기만큼 문자를 가져와 그대로 화면에 출력합니다. 이를 통해 맵 밀림 현상을 원천적으로 해결하고 렌더링 안정성을 확보했습니다.
- **`game.py` 수정**:
    - **대각선 이동 키 추가**: `y, u, b, n` 키를 이용한 대각선 이동 기능을 명시적으로 추가하여, 모든 방향의 이동이 `dungeon_map.move_player`를 통해 일관되게 처리되도록 수정했습니다. (이전 렌더링 문제로 인해 가려졌던 이동 로직 문제를 최종적으로 해결)

### `feat(game)`: 몬스터 아이템 드랍 및 루팅 기능 추가
- **`monster.py` 수정**: 몬스터가 죽었을 때 아이템 정보를 담을 수 있는 `loot` 속성을 추가하고, `to_dict`, `from_dict` 메서드에 이를 반영하여 저장/로드 기능을 지원하도록 수정했습니다.
- **`game.py` 수정**:
    - **아이템 드랍**: 몬스터가 죽으면 설정된 확률(50%)에 따라 무작위 아이템을 `loot` 속성에 할당하고, 관련 메시지를 출력하도록 전투 로직을 수정했습니다.
    - **아이템 루팅**: 'r' 키 입력 처리 로직을 추가했습니다. 플레이어는 이제 몬스터 시체(`%`) 위치에서 'r' 키를 눌러 드랍된 아이템을 인벤토리로 획득할 수 있습니다. 중복 획득은 방지됩니다.

